USE [CTN_PRODUCAO]
GO
select top 10 ID_LANCAMENTO, count(*) from HISTORICO_BAIXA_LANCAMENTO
group by ID_LANCAMENTO
having count(*) > 1


/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_BAIXA ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) 	******/
USE [CTN_PRODUCAO]
GO
SET IDENTITY_INSERT HISTORICO_BAIXA_LANCAMENTO ON
GO
INSERT INTO HISTORICO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from Lancamento L (nolock) where   CONVERT( DATE, L.DT_BAIXA ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) and NOT EXISTS(select top 1 H2.ID_LANCAMENTO from HISTORICO_BAIXA_LANCAMENTO H2 (nolock) where H2.ID_LANCAMENTO = L.ID_LANCAMENTO)
GO
SET IDENTITY_INSERT HISTORICO_BAIXA_LANCAMENTO OFF
GO

/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) ******/
USE [CTN_PRODUCAO]
GO
SET IDENTITY_INSERT HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ON
GO
INSERT INTO  HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from Lancamento L (nolock) where   CONVERT( DATE, L.DT_CANCELAMENTO ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) and NOT EXISTS(select top 1 H2.ID_LANCAMENTO from  HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO H2 (nolock) where H2.ID_LANCAMENTO = L.ID_LANCAMENTO)
GO
SET IDENTITY_INSERT HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO OFF
GO

/********************************************************************************************************************************************************************************************************************/

/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_BAIXA ) =  CONVERT( DATE, DATEADD ( DAY ,-1, GETDATE ( ) ) ) 	******/
USE [CTN_PRODUCAO]
GO
SELECT * into  TMPBAIXALANCAMENTO from Lancamento (nolock) where CONVERT( DATE, DT_BAIXA ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) 
GO

DELETE FROM TMPBAIXALANCAMENTO Where  ID_LANCAMENTO  in (select ID_LANCAMENTO from HISTORICO_BAIXA_LANCAMENTO (nolock) where HISTORICO_BAIXA_LANCAMENTO.ID_LANCAMENTO = TMPBAIXALANCAMENTO.ID_LANCAMENTO)
GO

INSERT INTO HISTORICO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from TMPBAIXALANCAMENTO
GO


/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_CANCELAMENTO) =  CONVERT( DATE, DATEADD ( DAY ,-1, GETDATE ( ) ) ) ******/
USE [CTN_PRODUCAO]
GO
SELECT * into TMPCANCELAMENTOLANCAMENTO from Lancamento (nolock) where CONVERT( DATE, DT_CANCELAMENTO ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) 
GO

DELETE FROM TMPCANCELAMENTOLANCAMENTO Where  ID_LANCAMENTO  in (select ID_LANCAMENTO from HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO (nolock) where HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO.ID_LANCAMENTO = TMPCANCELAMENTOLANCAMENTO.ID_LANCAMENTO)
GO

INSERT INTO HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from TMPCANCELAMENTOLANCAMENTO