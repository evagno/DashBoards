SELECT  
	A.MATRICULA,
	G.DESCRICAO AS[STATUS FILIADO],
	E.NOME_FANTASIA,
	--B.ID_PESSOA, 
	B.NOME, 
	B.CPF, 
	(SELECT TOP 1 G.NUMERO FROM DBO.PESSOA_TELEFONE (NOLOCK) G WHERE ID_TIPO_TELEFONE = 1 AND ID_PESSOA = A.ID_PESSOA ORDER BY ID_PESSOA_TELEFONE DESC) 'TELEFONE',    
    (SELECT TOP 1 G.NUMERO FROM DBO.PESSOA_TELEFONE (NOLOCK) G WHERE ID_TIPO_TELEFONE = 2 AND ID_PESSOA = A.ID_PESSOA ORDER BY ID_PESSOA_TELEFONE DESC) 'CELULAR',
	B.EMAIL, 
	A.ENDERECO AS RUA, 
	A.NUMERO, 
	A.COMPLEMENTO, 
	A.BAIRRO, 
	A.CIDADE, 
	A.CEP,
	A.UF, 
	--L.NOME VENDEDOR,
	F.NOME AS [FORMA DE COBRANÇA],
	--H.COD_OPERACAO,
	--H.DESSCRICAO,
            /*
			CASE WHEN C.ATIVO=0 THEN 'CANCELADO' ELSE
			CASE WHEN C.ATIVO=1 THEN 'ATIVO' ELSE	
			CASE WHEN C.ATIVO=2 THEN 'ALTERADO'
			END END END AS [STATUS CONTRATO],
			*/
	--D.DT_MES_ANO_COMPETENCIA,
	COUNT(D.DT_MES_ANO_COMPETENCIA) AS [QUANTIDADE EM ABERTO],
	CONVERT(MONEY, (SUM(D.VALOR_ORIGINAL_SERVICO))) AS VALOR, 
	CONVERT(VARCHAR,A.DT_FILIACAO,103) DT_FILIACAO
	--CONTRATO.NOME AS [CONTRATO ATIVO]
			  
FROM            
	FILIADO AS A  (NOLOCK) 
	INNER JOIN PESSOA AS B  (NOLOCK) ON A.ID_PESSOA = B.ID_PESSOA 
	INNER JOIN CONTRATO AS C  (NOLOCK) ON C.ID_FILIADO = A.ID_FILIADO 
	INNER JOIN LANCAMENTO AS D  (NOLOCK) ON D.ID_CONTRATO = C.ID_CONTRATO 
	INNER JOIN FRANQUIA AS E (NOLOCK)ON E.ID_FRANQUIA = A.ID_FRANQUIA 
	INNER JOIN FORMA_PGTO AS F (NOLOCK) ON F.ID_FORMA_PGTO = C.ID_FORMA_PGTO 
	INNER JOIN TIPO_STATUS_FILIADO AS G ON G.ID_TIPO_STATUS_FILIADO = A.ATIVO
	JOIN PROMOTOR_VENDAS AS J ON C.ID_PROMOTOR_VENDAS = J.ID_PROMOTOR_VENDAS
	JOIN PESSOA AS L ON J.ID_PESSOA = L.ID_PESSOA
	--JOIN DAD_DEBITO_BANCARIO (NOLOCK) H ON C.ID_CONTRATO = H.ID_CONTRATO
	--DAD_OCORRENCIAS (NOLOCK) H ON F.ID_FORMA_PGTO = H.ID_FORMA_PGTO  
			/*		 
	CROSS APPLY
        (
        SELECT  TOP 1 ID_CONTRATO,NOME
		FROM    CONTRATO	
		JOIN FORMA_PGTO ON FORMA_PGTO.ID_FORMA_PGTO=CONTRATO.ID_FORMA_PGTO	     
        WHERE   CONTRATO.ID_FILIADO = C.ID_FILIADO
		AND CONTRATO.ID_SERVICO=1
		ORDER BY ID_CONTRATO DESC
        ) CONTRATO
		*/
WHERE 
    
	D.DT_MES_ANO_COMPETENCIA NOT IN ('2022/04')
	AND D.DT_VENCIMENTO < GETDATE() 
	AND A.ID_FRANQUIA = 46
	AND (A.ATIVO=1)
	AND (A.ID_FILIADO_PAI IS NULL) 
	AND (C.ID_SERVICO = 1) 
	AND D.STATUS_LAN NOT IN (0,1,9) 
	--AND C.ATIVO = 1
	--AND B.NOME LIKE 'JOSE%'
	--AND H.ID = '04'
	--AND D.STATUS_LAN = 0
	--AND D.DT_TERMINO_ENVIO < GETDATE()
	--AND A.CIDADE LIKE '%NOVA SE%'
	--AND A.DT_FILIACAO BETWEEN '2019-11-01' AND '2020-01-31 23:59:59'
	--AND F.ID_FORMA_PGTO IN (5300088, 5300083)
	--AND F.ID_FORMA_PGTO_PAI IN (100, 5300049, 5300071, 5300089,99)
	--AND F.ID_FORMA_PGTO_PAI = 400
	--AND F.ID_FORMA_PGTO = 22

GROUP BY  E.NOME_FANTASIA, A.MATRICULA, B.NOME, B.CPF, A.ID_PESSOA,B.EMAIL, A.ENDERECO, A.NUMERO, A.COMPLEMENTO, A.BAIRRO, A.CIDADE, A.UF,A.DT_FILIACAO,B.ID_PESSOA,A.CEP, F.NOME, G.DESCRICAO, L.NOME--, H.COD_OPERACAO
HAVING COUNT(D.DT_MES_ANO_COMPETENCIA) >= 1
ORDER BY A.MATRICULA--, D.DT_MES_ANO_COMPETENCIA

--SELECT * FROM FRANQUIA WHERE NOME_FANTASIA LIKE '%RECIFE%'

--SELECT * FROM FORMA_PGTO WHERE NOME LIKE '%RGE%'

 -- SELECT * FROM SERVICO