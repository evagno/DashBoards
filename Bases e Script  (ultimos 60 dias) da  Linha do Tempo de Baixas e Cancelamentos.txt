/****** Script de Criação da Tabela HISTORICO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Repositorio das Baixas realizadas por Data da Baixa ******/

USE [CTN_PRODUCAO]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[HISTORICO_BAIXA_LANCAMENTO](
	[ID_LANCAMENTO] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[ID_CONTRATO] [int] NOT NULL,
	[ID_FORMA_RECEBIMENTO] [int] NULL,
	[NUMERO_DOC] [nvarchar](40) NULL,
	[COD_BARRA] [nvarchar](44) NULL,
	[IPTE] [nvarchar](48) NULL,
	[CNAB] [nvarchar](20) NULL,
	[PAGREC] [smallint] NULL,
	[STATUS_LAN] [smallint] NULL,
	[HISTORICO] [nvarchar](244) NULL,
	[DT_CRIACAO] [datetime] NULL,
	[DT_VENCIMENTO] [datetime] NULL,
	[DT_EMISSAO] [datetime] NULL,
	[DT_BAIXA] [datetime] NULL,
	[DT_PREV_BAIXA] [datetime] NULL,
	[DT_CANCELAMENTO] [datetime] NULL,
	[DT_MES_ANO_COMPETENCIA] [nvarchar](7) NULL,
	[VALOR_ORIGINAL_SERVICO] [numeric](15, 4) NULL,
	[VALOR_BAIXADO] [numeric](15, 4) NULL,
	[VALOR_JUROS] [numeric](15, 4) NULL,
	[VALOR_MULTA] [numeric](15, 4) NULL,
	[VALOR_DESCONTO] [numeric](15, 4) NULL,
	[ID_USUARIO_BAIXA] [int] NULL,
	[DT_ALTERACAO] [datetime] NULL,
	[ID_USUARIO_SISTEMA] [int] NULL,
	[NUM_PARCELA] [int] NULL,
	[NUMATRICULA] [nvarchar](11) NULL,
	[NOME_ARQUIVO] [nvarchar](255) NULL,
	[CARTEIRA] [nvarchar](15) NULL,
	[VL_TARIFA] [numeric](15, 4) NULL,
	[cod_ocorrencia] [nvarchar](5) NULL,
	[ID_EXPORTADO_CAIXA] [int] NULL,
	[FLAG_ENVIO] [smallint] NULL,
	[FLAG_FATURAMENTO] [smallint] NULL,
	[FLAG_BAIXA] [smallint] NULL,
	[FLAG_REFATURAMENTO] [smallint] NULL,
	[DT_REFATURAMENTO] [datetime] NULL,
	[FLAG_INRREGULAR] [smallint] NULL,
	[DT_FATURAMENTO] [datetime] NULL,
	[DT_INRREGULAR] [datetime] NULL,
	[FLAG_ACUMULADO] [int] NULL,
	[DT_TERMINO_ENVIO] [datetime] NULL,
	[ID_USUARIO_CANCELAMENTO] [int] NULL,
	[DATA_VENDA] [datetime] NULL,
	[TID_MAIS_TODOS] [int] NULL,
	[NSU] [varchar](100) NULL,
 CONSTRAINT [PK_BAIXA_LANCAMENTO] PRIMARY KEY CLUSTERED 
(
	[ID_LANCAMENTO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_BAIXA ) =  CONVERT( DATE, DATEADD ( DAY ,-1, GETDATE ( ) ) ) 	******/
USE [CTN_PRODUCAO]
GO
SET IDENTITY_INSERT HISTORICO_BAIXA_LANCAMENTO ON
GO
INSERT INTO HISTORICO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from Lancamento L (nolock) where   CONVERT( DATE, L.DT_BAIXA ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) 
and NOT EXISTS(select top 1 H.ID_LANCAMENTO from HISTORICO_BAIXA_LANCAMENTO H (nolock) where H.ID_LANCAMENTO = L.ID_LANCAMENTO)
GO
SET IDENTITY_INSERT HISTORICO_BAIXA_LANCAMENTO OFF
GO

/****** Script de Criação da Tabela HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Repositorio das Baixas realizadas por Data da Baixa ******/

USE [CTN_PRODUCAO]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO](
	[ID_LANCAMENTO] [int] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
	[ID_CONTRATO] [int] NOT NULL,
	[ID_FORMA_RECEBIMENTO] [int] NULL,
	[NUMERO_DOC] [nvarchar](40) NULL,
	[COD_BARRA] [nvarchar](44) NULL,
	[IPTE] [nvarchar](48) NULL,
	[CNAB] [nvarchar](20) NULL,
	[PAGREC] [smallint] NULL,
	[STATUS_LAN] [smallint] NULL,
	[HISTORICO] [nvarchar](244) NULL,
	[DT_CRIACAO] [datetime] NULL,
	[DT_VENCIMENTO] [datetime] NULL,
	[DT_EMISSAO] [datetime] NULL,
	[DT_BAIXA] [datetime] NULL,
	[DT_PREV_BAIXA] [datetime] NULL,
	[DT_CANCELAMENTO] [datetime] NULL,
	[DT_MES_ANO_COMPETENCIA] [nvarchar](7) NULL,
	[VALOR_ORIGINAL_SERVICO] [numeric](15, 4) NULL,
	[VALOR_BAIXADO] [numeric](15, 4) NULL,
	[VALOR_JUROS] [numeric](15, 4) NULL,
	[VALOR_MULTA] [numeric](15, 4) NULL,
	[VALOR_DESCONTO] [numeric](15, 4) NULL,
	[ID_USUARIO_BAIXA] [int] NULL,
	[DT_ALTERACAO] [datetime] NULL,
	[ID_USUARIO_SISTEMA] [int] NULL,
	[NUM_PARCELA] [int] NULL,
	[NUMATRICULA] [nvarchar](11) NULL,
	[NOME_ARQUIVO] [nvarchar](255) NULL,
	[CARTEIRA] [nvarchar](15) NULL,
	[VL_TARIFA] [numeric](15, 4) NULL,
	[cod_ocorrencia] [nvarchar](5) NULL,
	[ID_EXPORTADO_CAIXA] [int] NULL,
	[FLAG_ENVIO] [smallint] NULL,
	[FLAG_FATURAMENTO] [smallint] NULL,
	[FLAG_BAIXA] [smallint] NULL,
	[FLAG_REFATURAMENTO] [smallint] NULL,
	[DT_REFATURAMENTO] [datetime] NULL,
	[FLAG_INRREGULAR] [smallint] NULL,
	[DT_FATURAMENTO] [datetime] NULL,
	[DT_INRREGULAR] [datetime] NULL,
	[FLAG_ACUMULADO] [int] NULL,
	[DT_TERMINO_ENVIO] [datetime] NULL,
	[ID_USUARIO_CANCELAMENTO] [int] NULL,
	[DATA_VENDA] [datetime] NULL,
	[TID_MAIS_TODOS] [int] NULL,
	[NSU] [varchar](100) NULL,
 CONSTRAINT [PK_CANCELAMENTO_BAIXA_LANCAMENTO] PRIMARY KEY CLUSTERED 
(
	[ID_LANCAMENTO] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

/****** Script de execução DIAIRA de Transferencia das Baixas para Tabela HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ******/
/****** Objetivo: Incluir as Baixas realizadas DIARIAMENTE na Tabela  HISTORICO_BAIXA_LANCAMENTO 	******/
/****** OBSERVAÇÃO: CONVERT( DATE, DT_CANCELAMENTO) =  CONVERT( DATE, DATEADD ( DAY ,-1, GETDATE ( ) ) ) ******/
USE [CTN_PRODUCAO]
GO
SET IDENTITY_INSERT HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ON
GO
INSERT INTO  HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO with (TABLOCK) ( ID_LANCAMENTO, ID_CONTRATO, ID_FORMA_RECEBIMENTO, NUMERO_DOC, COD_BARRA, IPTE, CNAB, PAGREC, STATUS_LAN, HISTORICO, DT_CRIACAO, DT_VENCIMENTO, DT_EMISSAO, DT_BAIXA, DT_PREV_BAIXA, DT_CANCELAMENTO, DT_MES_ANO_COMPETENCIA, VALOR_ORIGINAL_SERVICO, VALOR_BAIXADO, VALOR_JUROS, VALOR_MULTA, VALOR_DESCONTO, ID_USUARIO_BAIXA, DT_ALTERACAO, ID_USUARIO_SISTEMA, NUM_PARCELA, NUMATRICULA, NOME_ARQUIVO, CARTEIRA, VL_TARIFA, cod_ocorrencia, ID_EXPORTADO_CAIXA, FLAG_ENVIO, FLAG_FATURAMENTO, FLAG_BAIXA, FLAG_REFATURAMENTO, DT_REFATURAMENTO, FLAG_INRREGULAR, DT_FATURAMENTO, DT_INRREGULAR, FLAG_ACUMULADO, DT_TERMINO_ENVIO, ID_USUARIO_CANCELAMENTO, DATA_VENDA, TID_MAIS_TODOS, NSU  ) 
SELECT * from Lancamento L (nolock) where   CONVERT( DATE, L.DT_CANCELAMENTO ) >  CONVERT( DATE, DATEADD ( DAY ,-91, GETDATE ( ) ) ) 
and NOT EXISTS(select top 1 H.ID_LANCAMENTO from  HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO H (nolock) where H.ID_LANCAMENTO = L.ID_LANCAMENTO)
GO
SET IDENTITY_INSERT HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO OFF
GO
