/*** Base da Consulta RELATORIO DA LORENNA ***/

SELECT
C.NOME_FANTASIA AS REGIONAL,
B.NOME_FANTASIA AS FRANQUIA,
A.MATRICULA,
CONTRATO.ID_CONTRATO,
CONTRATO.DT_MES_ANO_COMPETENCIA
FROM FILIADO A (NOLOCK)
JOIN FRANQUIA B (NOLOCK) ON A.ID_FRANQUIA = B.ID_FRANQUIA
JOIN FRANQUIA C (NOLOCK) ON B.ID_SUB_FRANQUIA = C.ID_FRANQUIA
CROSS APPLY (
SELECT
D.ID_CONTRATO,
E.DT_MES_ANO_COMPETENCIA
FROM CONTRATO D (NOLOCK)
JOIN LANCAMENTO E (NOLOCK) ON D.ID_CONTRATO = E.ID_CONTRATO
JOIN FORMA_PGTO F (NOLOCK) ON E.ID_FORMA_RECEBIMENTO = F.ID_FORMA_PGTO
WHERE E.STATUS_LAN = 5 -- STATUS EM ABERTO
AND F.ID_FORMA_PGTO_PAI = 3200 -- NA FORMA DE PAGAMENTO DIRETO NO CARTÃO. ISSO SIGNIFICA QUE A FRANQUIA FEZ UMA "BAIXA" DE UM LANÇAMENTO MANUAL
AND A.ID_FILIADO = D.ID_FILIADO
AND CAST(E.DT_CANCELAMENTO AS DATE) = CAST(E.DT_CRIACAO AS DATE)
GROUP BY D.ID_CONTRATO, E.DT_MES_ANO_COMPETENCIA
) CONTRATO
WHERE A.ID_FILIADO_PAI IS NULL
ORDER BY 1,2


/*********************************************************************************************************************************************************************************************************/
/****** Script de EXECUÇÃO DIARIA da Tabela TMP... ******/

/****** Script de Criação da Tabela TMPREGIONAIS ******/
/***drop table TMPREGIONAIS ***/
 GO

USE [CTN_PRODUCAO]
GO

SELECT * into TMPREGIONAIS
  FROM [CTN_PRODUCAO].[dbo].[FRANQUIA]
  Where ID_SUB_FRANQUIA is null 
GO

/****** Script de EXECUÇÃO DIARIA para atualização da Tabela TMPHISTCANCELAMENTOLANCAMENTO ******/
/****** Baseado na tabela HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO ******/

USE [CTN_PRODUCAO]
GO

SELECT
D.ID_FRANQUIA as ID_SUB_FRANQUIA,
C.ID_FRANQUIA,  
U.ID_USUARIO,  
CONVERT( DATE, CONVERT( VARCHAR, B.DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO,
COUNT (B.ID_LANCAMENTO) AS QTD_HIST
into TMPHISTCANCELAMENTOLANCAMENTO
FROM CONTRATO A (NOLOCK)
JOIN HISTORICO_CANCELAMENTO_BAIXA_LANCAMENTO B (NOLOCK) ON A.ID_CONTRATO = B.ID_CONTRATO
JOIN FRANQUIA C (NOLOCK) ON A.ID_FRANQUIA = C.ID_FRANQUIA
JOIN FRANQUIA D (NOLOCK) ON C.ID_SUB_FRANQUIA = D.ID_FRANQUIA
join S_USUARIO U (nolock) ON B.ID_USUARIO_CANCELAMENTO = U.ID_USUARIO
JOIN FORMA_PGTO E (NOLOCK) ON B.ID_FORMA_RECEBIMENTO = E.ID_FORMA_PGTO
JOIN FILIADO F (NOLOCK) ON A.ID_FILIADO = F.ID_FILIADO
WHERE  B.STATUS_LAN = 5 -- STATUS EM ABERTO
AND E.ID_FORMA_PGTO_PAI = 3200 -- NA FORMA DE PAGAMENTO DIRETO NO CARTÃO. ISSO SIGNIFICA QUE A FRANQUIA FEZ UMA BAIXA DE UM LANÇAMENTO MANUAL
--AND A.ID_FILIADO = D.ID_FILIADO
AND CAST(B.DT_CANCELAMENTO AS DATE) = CAST(B.DT_CRIACAO AS DATE)
GROUP BY D.ID_FRANQUIA, C.ID_FRANQUIA, U.ID_USUARIO, CONVERT( DATE, CONVERT( VARCHAR, B.DT_CANCELAMENTO, 120)) 
ORDER BY 1,2,3,4


/****** Script de EXECUÇÃO DIARIA para atualização da Tabela TMPATUALCANCELAMENTOLANCAMENTO ******/
/****** Baseado na tabela LANCAMENTO ******/

USE [CTN_PRODUCAO]
GO

SELECT
D.ID_FRANQUIA as ID_SUB_FRANQUIA,
C.ID_FRANQUIA,  
U.ID_USUARIO,  
CONVERT( DATE, CONVERT( VARCHAR, B.DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO,
COUNT (B.ID_LANCAMENTO) AS QTD_ATUAL
into TMPATUALCANCELAMENTOLANCAMENTO
FROM CONTRATO A (NOLOCK)
JOIN LANCAMENTO B (NOLOCK) ON A.ID_CONTRATO = B.ID_CONTRATO
JOIN FRANQUIA C (NOLOCK) ON A.ID_FRANQUIA = C.ID_FRANQUIA
JOIN FRANQUIA D (NOLOCK) ON C.ID_SUB_FRANQUIA = D.ID_FRANQUIA
join S_USUARIO U (nolock) ON B.ID_USUARIO_CANCELAMENTO = U.ID_USUARIO
JOIN FORMA_PGTO E (NOLOCK) ON B.ID_FORMA_RECEBIMENTO = E.ID_FORMA_PGTO
JOIN FILIADO F (NOLOCK) ON A.ID_FILIADO = F.ID_FILIADO
WHERE  B.STATUS_LAN = 5 -- STATUS EM ABERTO
AND E.ID_FORMA_PGTO_PAI = 3200 -- NA FORMA DE PAGAMENTO DIRETO NO CARTÃO. ISSO SIGNIFICA QUE A FRANQUIA FEZ UMA BAIXA DE UM LANÇAMENTO MANUAL
--AND A.ID_FILIADO = D.ID_FILIADO
AND CAST(B.DT_CANCELAMENTO AS DATE) = CAST(B.DT_CRIACAO AS DATE)
GROUP BY D.ID_FRANQUIA, C.ID_FRANQUIA, U.ID_USUARIO, CONVERT( DATE, CONVERT( VARCHAR, B.DT_CANCELAMENTO, 120)) 
ORDER BY 1,2,3,4

/*** Atualiza o QTD_ATUAL na tabela TMPHISTCANCELAMENTOLANCAMENTO ***/
ALTER TABLE TMPHISTCANCELAMENTOLANCAMENTO
    ADD 
	QTD_ATUAL int,
	FLAG int;
GO

/*** Deve vir de outra tabela mantida historicamente ***/
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.QTD_ATUAL=(SELECT TMPATUALCANCELAMENTOLANCAMENTO.QTD_ATUAL
                            FROM  TMPATUALCANCELAMENTOLANCAMENTO (nolock)
                            WHERE TMPATUALCANCELAMENTOLANCAMENTO.DT_CANCELAMENTO=TMPHISTCANCELAMENTOLANCAMENTO.DT_CANCELAMENTO
					and TMPATUALCANCELAMENTOLANCAMENTO.ID_USUARIO=TMPHISTCANCELAMENTOLANCAMENTO.ID_USUARIO
					and TMPATUALCANCELAMENTOLANCAMENTO.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA)

GO
/****** Limpeza (QTDs NULAS) da base dos dados ******/
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.QTD_ATUAL=0
                            WHERE TMPHISTCANCELAMENTOLANCAMENTO.QTD_ATUAL is null

GO
/*** Ativa o FLAG dos registro com diferença entre QTD_HIST e QTD_ATUAL ***/
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.FLAG=(SELECT (TMPHISTCANCELAMENTOLANCAMENTO.QTD_ATUAL-TMPHISTCANCELAMENTOLANCAMENTO.QTD_HIST) AS Result )
                        
GO

/****** Limpeza (QTDs NULAS) da base dos dados ******/
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET TMPHISTCANCELAMENTOLANCAMENTO.FLAG=0
					   WHERE TMPHISTCANCELAMENTOLANCAMENTO.FLAG is null

/****** Script de Alteração da Tabela TMPHISTCANCELAMENTOLANCAMENTO ******/
/****** Objetivo: Complementar as informaççoes no Repositorio de totalização das CANCELAMENTOs realizadas por Usuario e Data da CANCELAMENTO ******/

ALTER TABLE TMPHISTCANCELAMENTOLANCAMENTO
    ADD 
	ID_FUNCIONARIO int,
	ID_PESSOA int,
	NOME_PESSOA nvarchar(150),
	NOME_FANTASIA nvarchar(50),
	CEP varchar(8),
	UF char(2),
	NOME_REGIONAL nvarchar(50);
GO


UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.ID_FUNCIONARIO=(SELECT S_USUARIO.ID_FUNCIONARIO
                            FROM S_USUARIO (nolock)
                            WHERE S_USUARIO.ID_USUARIO=TMPHISTCANCELAMENTOLANCAMENTO.ID_USUARIO)
GO

UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.ID_PESSOA=(SELECT FUNCIONARIO.ID_PESSOA
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPHISTCANCELAMENTOLANCAMENTO.ID_FUNCIONARIO)
GO
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.NOME_PESSOA=(SELECT PESSOA.NOME
                            FROM PESSOA (nolock)
                            WHERE PESSOA.ID_PESSOA=TMPHISTCANCELAMENTOLANCAMENTO.ID_PESSOA)
GO

/*** UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA=(SELECT TOP (1) FUNCIONARIO_FRANQUIA.ID_FRANQUIA
                            FROM FUNCIONARIO_FRANQUIA (nolock), FRANQUIA (nolock)
                            WHERE FUNCIONARIO_FRANQUIA.ID_FRANQUIA=FRANQUIA.ID_FRANQUIA and FRANQUIA.ID_SUB_FRANQUIA is not null and FRANQUIA.ID_TIPO_FRANQUIA = 3
							and FUNCIONARIO_FRANQUIA.ID_FUNCIONARIO=TMPHISTCANCELAMENTOLANCAMENTO.ID_FUNCIONARIO order by FUNCIONARIO_FRANQUIA.DT_alteracao DESC)
GO ***/

UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.NOME_FANTASIA=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA)
GO
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.CEP=(SELECT FRANQUIA.CEP
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA)
GO
UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.UF=(SELECT FRANQUIA.UF
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA)
GO

/*** UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.ID_SUB_FRANQUIA=(SELECT FRANQUIA.ID_SUB_FRANQUIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_FRANQUIA)
GO ***/

UPDATE TMPHISTCANCELAMENTOLANCAMENTO
SET  TMPHISTCANCELAMENTOLANCAMENTO.NOME_REGIONAL=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPHISTCANCELAMENTOLANCAMENTO.ID_SUB_FRANQUIA)
GO

/****** Limpeza (CANCELAMENTOS FUTURAS) da base dos dados ******/
delete 
  FROM TMPHISTCANCELAMENTOLANCAMENTO
  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,365, GETDATE ( ) ) )
GO
/*********************************************************************************************************************************************************************************************************/



