/*** Base da Consulta TMPCANCELAMENTOLANCAMENTO ***/

SELECT 
  LANCAMENTO.*, CONTRATO.ID_FILIADO, FILIADO.MATRICULA
FROM
  LANCAMENTO (nolock), CONTRATO, FILIADO
  WHERE CONVERT( DATE, LANCAMENTO.DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and LANCAMENTO.HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and LANCAMENTO.HISTORICO not like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and LANCAMENTO.ID_USUARIO_CANCELAMENTO > 1
  	and CONTRATO.ID_CONTRATO=LANCAMENTO.ID_CONTRATO and FILIADO.ID_FILIADO=CONTRATO.ID_FILIADO
/***	and STATUS_LAN = 0 ***/
GO



/****** Script de EXECUÇÃO DIARIA da Tabela TMP... ******/

/****** Script de Criação da Tabela TMPREGIONAIS ******/
/***drop table TMPREGIONAIS ***/
 GO

USE [CTN_PRODUCAO]
GO

SELECT * into TMPREGIONAIS
  FROM [CTN_PRODUCAO].[dbo].[FRANQUIA]
  Where ID_SUB_FRANQUIA is null 
GO

/*********************************************************************************************************************************************************************************************************/

/****** Script de Criação da Tabela TMPREFILIACAOLANCAMENTOUSUARIODATA ******/
/****** Objetivo: Repositorio de totalização das Baixas realizadas por Usuario e Data da Baixa ******/
/****** ATENÇÃO:  HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' ******/

USE [CTN_PRODUCAO]
GO
/*** drop table TMPREFILIACAOLANCAMENTO ***/
GO

SELECT 
  ID_USUARIO_CANCELAMENTO, ID_CONTRATO, DT_CANCELAMENTO 
  into TMPREFILIACAOLANCAMENTO 
FROM
  LANCAMENTO (nolock)
  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
/***	and STATUS_LAN = 0 ***/
GO
/****** Script de Alteração da Tabela TMPREFILIACAOLANCAMENTO ******/
/****** Objetivo: Complementar as informaççoes no Repositorio de totalização das Baixas realizadas por FILIADO/MATRICULA ******/

USE [CTN_PRODUCAO]
GO

ALTER TABLE TMPREFILIACAOLANCAMENTO 
    ADD 
	ID_FILIADO int,
	MATRICULA  nvarchar(15);
GO
/****** Objetivo: Acrescentar a MATRICULA na Tabela ******/
UPDATE TMPREFILIACAOLANCAMENTO
SET  TMPREFILIACAOLANCAMENTO.ID_FILIADO=(SELECT CONTRATO.ID_FILIADO
                            FROM CONTRATO (nolock)
                            WHERE CONTRATO.ID_CONTRATO=TMPREFILIACAOLANCAMENTO.ID_CONTRATO)
GO
UPDATE TMPREFILIACAOLANCAMENTO
SET  TMPREFILIACAOLANCAMENTO.MATRICULA=(SELECT FILIADO.MATRICULA
                            FROM FILIADO (nolock)
                            WHERE FILIADO.ID_FILIADO=TMPREFILIACAOLANCAMENTO.ID_FILIADO)
GO


/*** drop table TMPREFILIACAOLANCAMENTOUSUARIODATAMATRICULA ***/
 GO
SELECT 
  ID_USUARIO_CANCELAMENTO, MATRICULA, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO, COUNT(*) as CONTADOR
  into TMPREFILIACAOLANCAMENTOUSUARIODATAMATRICULA
FROM
  TMPREFILIACAOLANCAMENTO (nolock)
/***  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
***/
GROUP BY
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)), MATRICULA
  GO

/*** drop table TMPREFILIACAOLANCAMENTOUSUARIODATA ***/
 GO
SELECT 
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO, COUNT(*) as CONTADOR
  into TMPREFILIACAOLANCAMENTOUSUARIODATA
FROM
  TMPREFILIACAOLANCAMENTOUSUARIODATAMATRICULA (nolock)
/***  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
***/
GROUP BY
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120))
  GO


/*********************************************************************************************************************************************************************************************************/

/****** Script de Criação da Tabela TMPCANCELAMENTOLANCAMENTOUSUARIODATA ******/
/****** Objetivo: Repositorio de totalização das Baixas realizadas por Usuario e Data da Baixa ******/

USE [CTN_PRODUCAO]
GO
/*** drop table TMPCANCELAMENTOLANCAMENTO ***/
GO

SELECT 
  ID_USUARIO_CANCELAMENTO, ID_CONTRATO, DT_CANCELAMENTO 
  into TMPCANCELAMENTOLANCAMENTO 
FROM
  LANCAMENTO (nolock)
  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO not like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
	and STATUS_LAN = 0 
GO

/****** Script de Alteração da Tabela TMPREFILIACAOLANCAMENTO ******/
/****** Objetivo: Complementar as informaççoes no Repositorio de totalização das Baixas realizadas por FILIADO/MATRICULA ******/

USE [CTN_PRODUCAO]
GO

ALTER TABLE TMPCANCELAMENTOLANCAMENTO 
    ADD 
	ID_FILIADO int,
	MATRICULA  nvarchar(15);
GO
/****** Objetivo: Acrescentar a MATRICULA na Tabela ******/
UPDATE TMPCANCELAMENTOLANCAMENTO
SET  TMPCANCELAMENTOLANCAMENTO.ID_FILIADO=(SELECT CONTRATO.ID_FILIADO
                            FROM CONTRATO (nolock)
                            WHERE CONTRATO.ID_CONTRATO=TMPCANCELAMENTOLANCAMENTO.ID_CONTRATO)
GO
UPDATE TMPCANCELAMENTOLANCAMENTO
SET  TMPCANCELAMENTOLANCAMENTO.MATRICULA=(SELECT FILIADO.MATRICULA
                            FROM FILIADO (nolock)
                            WHERE FILIADO.ID_FILIADO=TMPCANCELAMENTOLANCAMENTO.ID_FILIADO)
GO


/*** drop table TMPCANCELAMENTOLANCAMENTOUSUARIODATAMATRICULA ***/
 GO
SELECT 
  ID_USUARIO_CANCELAMENTO, MATRICULA, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO, COUNT(*) as CONTADOR
  into TMPCANCELAMENTOLANCAMENTOUSUARIODATAMATRICULA
FROM
  TMPCANCELAMENTOLANCAMENTO (nolock)
/***  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
***/
GROUP BY
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)), MATRICULA
  GO

/*** drop table TMPCANCELAMENTOLANCAMENTOUSUARIODATA ***/
 GO
SELECT 
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO, COUNT(*) as CONTADOR
  into TMPCANCELAMENTOLANCAMENTOUSUARIODATA
FROM
  TMPCANCELAMENTOLANCAMENTOUSUARIODATAMATRICULA (nolock)
/***  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-731, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
***/
GROUP BY
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120))
  GO


/****** Script de Alteração da Tabela TMPCANCELAMENTOLANCAMENTOUSUARIODATA ******/
/****** Objetivo: Complementar as informaççoes no Repositorio de totalização das Baixas realizadas por Usuario e Data da Baixa ******/

USE [CTN_PRODUCAO]
GO

ALTER TABLE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
    ADD 
	CONTADOR_REFILIACAO int,
	ID_FUNCIONARIO int,
	ID_PESSOA int,
	NOME_PESSOA nvarchar(150),
	ID_FRANQUIA int,
	NOME_FANTASIA nvarchar(50),
	CEP varchar(8),
	UF char(2),
	ID_SUB_FRANQUIA int,
	NOME_REGIONAL nvarchar(50);
GO

/****** Objetivo: Acrescentar o Contador de Cancelamentos por REFILIAÇÃO na Tabela ******/
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CONTADOR_REFILIACAO=(SELECT TMPREFILIACAOLANCAMENTOUSUARIODATA.CONTADOR
                            FROM TMPREFILIACAOLANCAMENTOUSUARIODATA (nolock)
                            WHERE TMPREFILIACAOLANCAMENTOUSUARIODATA.ID_USUARIO_CANCELAMENTO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_USUARIO_CANCELAMENTO
							and TMPREFILIACAOLANCAMENTOUSUARIODATA.DT_CANCELAMENTO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.DT_CANCELAMENTO)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CONTADOR_REFILIACAO=0
							WHERE TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CONTADOR_REFILIACAO is null
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO=(SELECT S_USUARIO.ID_FUNCIONARIO
                            FROM S_USUARIO (nolock)
                            WHERE S_USUARIO.ID_USUARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_USUARIO_CANCELAMENTO)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_PESSOA=(SELECT FUNCIONARIO.ID_PESSOA
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_PESSOA=(SELECT PESSOA.NOME
                            FROM PESSOA (nolock)
                            WHERE PESSOA.ID_PESSOA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_PESSOA)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA=(SELECT TOP (1) FUNCIONARIO_FRANQUIA.ID_FRANQUIA
                            FROM FUNCIONARIO_FRANQUIA (nolock), FRANQUIA (nolock)
                            WHERE FUNCIONARIO_FRANQUIA.ID_FRANQUIA=FRANQUIA.ID_FRANQUIA and FRANQUIA.ID_SUB_FRANQUIA is not null and FRANQUIA.ID_TIPO_FRANQUIA = 3
							and FUNCIONARIO_FRANQUIA.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO order by FUNCIONARIO_FRANQUIA.DT_alteracao DESC)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_FANTASIA=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP=(SELECT FRANQUIA.CEP
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF=(SELECT FRANQUIA.UF
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_SUB_FRANQUIA=(SELECT FRANQUIA.ID_SUB_FRANQUIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_REGIONAL=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_SUB_FRANQUIA)
GO

/****** Limpeza (CEP e UF Nulos e Brancos) da base dos dados ******/
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP=(SELECT FUNCIONARIO.CEP
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO) 
					Where TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP is Null or TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP = '' 

GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF=(SELECT FUNCIONARIO.UF
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO) 
					Where TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF is Null or TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF = ''


GO

/****** Limpeza (APP VENDEDOR) da base dos dados ******/
delete 
  FROM TMPCANCELAMENTOLANCAMENTOUSUARIODATA
  WHERE NOME_PESSOA like '%APP%VENDEDOR%'
GO



