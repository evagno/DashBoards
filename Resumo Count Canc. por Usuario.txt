SELECT 
  *
FROM
  LANCAMENTO (nolock)
  WHERE CAST(DT_CANCELAMENTO as date) =  CAST('01/12/2021' as date)  and ID_USUARIO_CANCELAMENTO > 1
	and ID_USUARIO_CANCELAMENTO = 13783 
	

SELECT *, FUNCIONARIO_FRANQUIA.ID_FRANQUIA
                            FROM FUNCIONARIO_FRANQUIA (nolock), FRANQUIA (nolock)
							WHERE FUNCIONARIO_FRANQUIA.ID_FRANQUIA=FRANQUIA.ID_FRANQUIA 
								and FRANQUIA.ID_SUB_FRANQUIA is not null
                             order by FUNCIONARIO_FRANQUIA.DT_alteracao DESC


/****** Script de EXECUÇÃO DIARIA da Tabela TMP... ******/

/****** Script de Criação da Tabela TMPREGIONAIS ******/
USE [CTN_PRODUCAO]
GO

SELECT * into TMPREGIONAIS
  FROM [CTN_PRODUCAO].[dbo].[FRANQUIA]
  Where ID_SUB_FRANQUIA is null 
GO


/****** Script de Criação da Tabela TMPCANCELAMENTOLANCAMENTOUSUARIODATA ******/
/****** Objetivo: Repositorio de totalização das Baixas realizadas por Usuario e Data da Baixa ******/

USE [CTN_PRODUCAO]
GO

 drop table TMPCANCELAMENTOLANCAMENTOUSUARIODATA
 GO

SELECT 
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120)) as DT_CANCELAMENTO, COUNT(*) as CONTADOR
  into TMPCANCELAMENTOLANCAMENTOUSUARIODATA
FROM
  LANCAMENTO (nolock)
  WHERE CONVERT( DATE, DT_CANCELAMENTO) >  CONVERT( DATE, DATEADD ( DAY ,-121, GETDATE ( ) ) ) and HISTORICO not like '%LAN%AMENTO%FUTURO%EXCLUIDO%' and HISTORICO not like '%LAN%AMENTO%CANCELADO%PROCESSO%REFILIA%' and ID_USUARIO_CANCELAMENTO > 1
GROUP BY
  ID_USUARIO_CANCELAMENTO, CONVERT( DATE, CONVERT( VARCHAR, DT_CANCELAMENTO, 120))
  GO

/****** Script de Alteração da Tabela TMPCANCELAMENTOLANCAMENTOUSUARIODATA ******/
/****** Objetivo: Complementar as informaççoes no Repositorio de totalização das Baixas realizadas por Usuario e Data da Baixa ******/

USE [CTN_PRODUCAO]
GO

ALTER TABLE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
    ADD 
	ID_FUNCIONARIO int,
	ID_PESSOA int,
	NOME_PESSOA nvarchar(150),
	ID_FRANQUIA int,
	NOME_FANTASIA nvarchar(50),
	CEP varchar(8),
	UF char(2),
	ID_SUB_FRANQUIA int,
	NOME_REGIONAL nvarchar(50);
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO=(SELECT S_USUARIO.ID_FUNCIONARIO
                            FROM S_USUARIO (nolock)
                            WHERE S_USUARIO.ID_USUARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_USUARIO_CANCELAMENTO)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_PESSOA=(SELECT FUNCIONARIO.ID_PESSOA
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_PESSOA=(SELECT PESSOA.NOME
                            FROM PESSOA (nolock)
                            WHERE PESSOA.ID_PESSOA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_PESSOA)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA=(SELECT TOP (1) FUNCIONARIO_FRANQUIA.ID_FRANQUIA
                            FROM FUNCIONARIO_FRANQUIA (nolock), FRANQUIA (nolock)
                            WHERE FUNCIONARIO_FRANQUIA.ID_FRANQUIA=FRANQUIA.ID_FRANQUIA and FRANQUIA.ID_SUB_FRANQUIA is not null and FRANQUIA.ID_TIPO_FRANQUIA = 3
							and FUNCIONARIO_FRANQUIA.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO order by FUNCIONARIO_FRANQUIA.DT_alteracao DESC)
GO

UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_FANTASIA=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP=(SELECT FRANQUIA.CEP
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF=(SELECT FRANQUIA.UF
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_SUB_FRANQUIA=(SELECT FRANQUIA.ID_SUB_FRANQUIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FRANQUIA)
GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.NOME_REGIONAL=(SELECT FRANQUIA.NOME_FANTASIA
                            FROM FRANQUIA (nolock)
                            WHERE FRANQUIA.ID_FRANQUIA=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_SUB_FRANQUIA)
GO

/****** Limpeza (CEP e UF Nulos e Brancos) da base dos dados ******/
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP=(SELECT FUNCIONARIO.CEP
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO) 
					Where TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP is Null or TMPCANCELAMENTOLANCAMENTOUSUARIODATA.CEP = '' 

GO
UPDATE TMPCANCELAMENTOLANCAMENTOUSUARIODATA
SET  TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF=(SELECT FUNCIONARIO.UF
                            FROM FUNCIONARIO (nolock)
                            WHERE FUNCIONARIO.ID_FUNCIONARIO=TMPCANCELAMENTOLANCAMENTOUSUARIODATA.ID_FUNCIONARIO) 
					Where TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF is Null or TMPCANCELAMENTOLANCAMENTOUSUARIODATA.UF = ''


GO

/****** Limpeza (APP VENDEDOR) da base dos dados ******/
delete 
  FROM TMPCANCELAMENTOLANCAMENTOUSUARIODATA
  WHERE NOME_PESSOA like '%APP%VENDEDOR%'
GO



